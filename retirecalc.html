<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Monthly Withdrawal Calculator</title>
    <!-- Include Chart.js and Data Labels Plugin from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .slider-container {
            margin-bottom: 20px;
        }
        .slider-label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .slider-inputs {
            display: flex;
            align-items: center;
        }
        .slider-inputs input[type="range"] {
            flex-grow: 1;
            margin-right: 10px;
        }
        .slider-inputs input[type="number"] {
            width: 100px;
        }
        #chart-container {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>

<h1>Monthly Withdrawal Calculator</h1>

<div class="slider-container">
    <div class="slider-label">Starting Capital (€): <span id="startingCapitalDisplay">600,000</span></div>
    <div class="slider-inputs">
        <input type="range" id="startingCapital" min="10000" max="1000000" step="10000" value="600000">
        <input type="number" id="startingCapitalNumber" min="10000" max="1000000" step="10000" value="600000">
    </div>
</div>

<div class="slider-container">
    <div class="slider-label">Annual Interest Rate (%): <span id="interestRateDisplay">7.0</span></div>
    <div class="slider-inputs">
        <input type="range" id="interestRate" min="0" max="15" step="0.1" value="7">
        <input type="number" id="interestRateNumber" min="0" max="15" step="0.1" value="7">
    </div>
</div>

<div class="slider-container">
    <div class="slider-label">Tax on Capital Gains (%): <span id="taxRateDisplay">25.0</span></div>
    <div class="slider-inputs">
        <input type="range" id="taxRate" min="25" max="50" step="0.1" value="25">
        <input type="number" id="taxRateNumber" min="25" max="50" step="0.1" value="25">
    </div>
</div>

<div class="slider-container">
    <div class="slider-label">Fixed Monthly Amount (Rent) (€): <span id="fixedMonthlyAmountDisplay">1,000</span></div>
    <div class="slider-inputs">
        <input type="range" id="fixedMonthlyAmount" min="0" max="10000" step="100" value="1000">
        <input type="number" id="fixedMonthlyAmountNumber" min="0" max="10000" step="100" value="1000">
    </div>
</div>

<div class="slider-container">
    <div class="slider-label">Min Years: <span id="minYearsDisplay">10</span></div>
    <div class="slider-inputs">
        <input type="range" id="minYears" min="1" max="29" step="1" value="10">
        <input type="number" id="minYearsNumber" min="1" max="29" step="1" value="10">
    </div>
</div>

<div class="slider-container">
    <div class="slider-label">Max Years: <span id="maxYearsDisplay">20</span></div>
    <div class="slider-inputs">
        <input type="range" id="maxYears" min="2" max="30" step="1" value="20">
        <input type="number" id="maxYearsNumber" min="2" max="30" step="1" value="20">
    </div>
</div>

<div id="chart-container">
    <canvas id="withdrawalChart"></canvas>
</div>

<script>
    // Get references to the inputs and displays
    const startingCapitalInput = document.getElementById('startingCapital');
    const startingCapitalNumber = document.getElementById('startingCapitalNumber');
    const startingCapitalDisplay = document.getElementById('startingCapitalDisplay');

    const interestRateInput = document.getElementById('interestRate');
    const interestRateNumber = document.getElementById('interestRateNumber');
    const interestRateDisplay = document.getElementById('interestRateDisplay');

    const taxRateInput = document.getElementById('taxRate');
    const taxRateNumber = document.getElementById('taxRateNumber');
    const taxRateDisplay = document.getElementById('taxRateDisplay');

    const fixedMonthlyAmountInput = document.getElementById('fixedMonthlyAmount');
    const fixedMonthlyAmountNumber = document.getElementById('fixedMonthlyAmountNumber');
    const fixedMonthlyAmountDisplay = document.getElementById('fixedMonthlyAmountDisplay');

    const minYearsInput = document.getElementById('minYears');
    const minYearsNumber = document.getElementById('minYearsNumber');
    const minYearsDisplay = document.getElementById('minYearsDisplay');

    const maxYearsInput = document.getElementById('maxYears');
    const maxYearsNumber = document.getElementById('maxYearsNumber');
    const maxYearsDisplay = document.getElementById('maxYearsDisplay');

    // Synchronize range inputs and number inputs
    function syncInputs(rangeInput, numberInput, display, formatFunction) {
        function updateValues(value) {
            rangeInput.value = value;
            numberInput.value = value;
            display.textContent = formatFunction ? formatFunction(value) : value;
            updateChart();
        }

        rangeInput.addEventListener('input', () => {
            updateValues(rangeInput.value);
        });
        numberInput.addEventListener('input', () => {
            updateValues(numberInput.value);
        });
    }

    // Format functions
    function formatCurrency(value) {
        return parseFloat(value).toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatPercentage(value) {
        return parseFloat(value).toFixed(1);
    }

    // Synchronize inputs
    syncInputs(startingCapitalInput, startingCapitalNumber, startingCapitalDisplay, formatCurrency);
    syncInputs(interestRateInput, interestRateNumber, interestRateDisplay, formatPercentage);
    syncInputs(taxRateInput, taxRateNumber, taxRateDisplay, formatPercentage);
    syncInputs(fixedMonthlyAmountInput, fixedMonthlyAmountNumber, fixedMonthlyAmountDisplay, formatCurrency);
    syncInputs(minYearsInput, minYearsNumber, minYearsDisplay);
    syncInputs(maxYearsInput, maxYearsNumber, maxYearsDisplay);

    // Initialize chart
    let ctx = document.getElementById('withdrawalChart').getContext('2d');
    let withdrawalChart;

    function updateChart() {
        let startingCapital = parseFloat(startingCapitalInput.value);
        let annualInterestRate = parseFloat(interestRateInput.value);
        let taxRate = parseFloat(taxRateInput.value);
        let fixedMonthlyAmount = parseFloat(fixedMonthlyAmountInput.value);
        let minYears = parseInt(minYearsInput.value);
        let maxYears = parseInt(maxYearsInput.value);

        // Ensure minYears is less than maxYears
        if (minYears >= maxYears) {
            maxYears = minYears + 1;
            maxYearsInput.value = maxYears;
            maxYearsNumber.value = maxYears;
            maxYearsDisplay.textContent = maxYears;
        }

        // Calculate effective monthly interest rate after tax
        let monthlyInterestRate = (annualInterestRate / 100) / 12;
        let taxRateDecimal = taxRate / 100;
        let effectiveMonthlyInterestRate = monthlyInterestRate * (1 - taxRateDecimal);

        let yearsRange = [];
        let monthlyWithdrawals = [];
        let totalIncomes = [];

        for (let years = minYears; years <= maxYears; years++) {
            let n = years * 12; // Total number of months
            let PV = startingCapital;
            let r = effectiveMonthlyInterestRate;

            let PMT;
            if (r !== 0) {
                PMT = PV * r / (1 - Math.pow(1 + r, -n));
            } else {
                PMT = PV / n;
            }

            let totalIncome = PMT + fixedMonthlyAmount;

            yearsRange.push(years);
            monthlyWithdrawals.push(PMT);
            totalIncomes.push(totalIncome);
        }

        // Destroy previous chart if exists
        if (withdrawalChart) {
            withdrawalChart.destroy();
        }

        // Create new chart
        withdrawalChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: yearsRange,
                datasets: [{
                    label: 'Monthly Withdrawal (€)',
                    data: monthlyWithdrawals,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }, {
                    label: 'Total Achievable Income (€)',
                    data: totalIncomes,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': €' + parseFloat(context.parsed.y).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            }
                        }
                    },
                    datalabels: {
                        color: 'black',
                        anchor: 'end',
                        align: 'start',
                        rotation: -90,
                        formatter: function(value, context) {
                            if (context.datasetIndex === 0) {
                                let totalIncome = totalIncomes[context.dataIndex];
                                return 'Withdrawal: €' + parseFloat(value).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '\nTotal Income: €' + parseFloat(totalIncome).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            } else {
                                return '';
                            }
                        },
                        font: {
                            size: 10,
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Years to Withdraw Funds'
                        },
                        stacked: true,
                        ticks: {
                            precision: 0
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Amount (€)'
                        },
                        stacked: false,
                        ticks: {
                            callback: function(value) {
                                return '€' + value.toLocaleString('de-DE', { minimumFractionDigits: 0 });
                            }
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // Initial chart update
    updateChart();
</script>

</body>
</html>
